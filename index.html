<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Poker Notes – iPhone</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
:root{--bg:#0e0f10;--fg:#f2f2f2;--muted:#a5a7ab;--card:#1a1c1f;--accent:#4caf50;--danger:#e53935;--blue:#2196f3;--outline:#2a2d31}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Helvetica Neue",Arial}
.app{max-width:700px;margin:0 auto;padding:12px 12px 84px}
.topbar{position:sticky;top:0;background:var(--bg);padding:8px 12px 10px;border-bottom:1px solid var(--outline);z-index:5}
.tabs{display:flex;gap:8px;overflow-x:auto;padding:6px 0}
.tab{flex:1 1 auto;text-align:center;padding:10px;border:1px solid var(--outline);border-radius:10px;background:var(--card);cursor:pointer;user-select:none}
.tab.active{outline:2px solid var(--accent)}
.section{display:none;margin-top:12px}.section.active{display:block}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:10px;border:1px solid var(--outline);background:var(--card);color:var(--fg);cursor:pointer;user-select:none;touch-action:manipulation}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
.card{background:var(--card);border:1px solid var(--outline);border-radius:14px;padding:12px}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--outline);background:#101214;color:var(--fg);font-size:16px}
textarea{min-height:110px;resize:vertical}
.muted{color:var(--muted)}.spacer{height:12px}

/* TABLE */
.table-wrap{position:relative;aspect-ratio:1/1;width:100%;max-width:620px;margin:0 auto}
.table-circle{position:absolute;inset:0;margin:auto;border-radius:50%;border:1px dashed var(--outline)}
.seat{position:absolute;width:100px;height:118px;border-radius:12px;border:1px solid var(--outline);
      background:var(--card);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:6px 6px 8px;
      text-align:center;touch-action:manipulation;cursor:pointer}
.seat.assigned{outline:2px solid var(--blue)}
.seat .seat-avatar{width:72px;height:72px;border-radius:12px;border:1px solid var(--outline);object-fit:cover;display:block;margin-top:14px}
.seat .placeholder{width:72px;height:72px;border-radius:12px;border:1px solid var(--outline);display:flex;align-items:center;justify-content:center;margin-top:14px}
.seat .pos{position:absolute;top:4px;left:4px;background:#0009;border:1px solid var(--outline);color:#fff;
           font-size:11px;padding:2px 6px;border-radius:999px}
.seat .stack{margin-top:6px;width:86px;padding:4px 6px;font-size:12px;text-align:center;border-radius:8px;border:1px solid var(--outline);
             background:#101214;color:var(--fg)}
.seat .stack::placeholder{color:#70757a}

/* LISTE JOUEURS */
.list{display:flex;flex-direction:column;gap:8px}
.player-row{display:flex;gap:10px;align-items:center}
.avatar{width:56px;height:56px;border-radius:10px;background:#0b0c0d;border:1px solid var(--outline);object-fit:cover;flex:0 0 56px}
.avatar.sm{width:42px;height:42px;flex:0 0 42px}
.pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--outline);color:var(--muted)}
.toolbar{display:flex;gap:8px;overflow:auto}
.chip{padding:10px 12px;border-radius:999px;border:1px solid var(--outline);background:#121417;font-size:15px;cursor:pointer;user-select:none}

/* PIN overlay */
#pinLock{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:50}
#pinBox{background:var(--card);border:1px solid var(--outline);border-radius:16px;padding:16px;max-width:320px;width:90%}
</style>
</head>
<body>
  <!-- Écran PIN -->
  <div id="pinLock">
    <div id="pinBox">
      <h3>Déverrouiller</h3>
      <p class="muted" id="pinMsg">Entre ton code PIN</p>
      <input id="pinInput" placeholder="PIN" inputmode="numeric" maxlength="6" />
      <div class="spacer"></div>
      <div class="row">
        <button class="btn btn-primary" id="pinOk">OK</button>
        <button class="btn" id="pinCancel">Quitter</button>
      </div>
    </div>
  </div>

  <div class="topbar">
    <div class="tabs">
      <div class="tab active" data-tab="table">Table</div>
      <div class="tab" data-tab="players">Joueurs</div>
      <div class="tab" data-tab="export">Export / Import</div>
      <div class="tab" data-tab="help">Aide</div>
    </div>
  </div>

  <div class="app">
    <!-- TABLE -->
    <div id="table" class="section active">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row" style="gap:6px;align-items:center">
            <strong>Configuration :</strong>
            <select id="seatCount">
              <option value="6">6-max</option>
              <option value="8">8-max</option>
              <option value="9" selected>9-max</option>
              <option value="10">10-max</option>
            </select>
            <input id="tableName" placeholder="Nom de la table / Session" />
          </div>
          <button class="btn" id="btnClearTable">Vider la table</button>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="table-wrap">
        <div class="table-circle" id="tableCircle"></div>
        <div id="seatsContainer"></div>
      </div>

      <div class="spacer"></div>
      <div class="card">
        <div class="toolbar" id="quickTagsBar"></div>
        <div class="muted" style="font-size:12px;margin-top:6px">
          Tap bref = assigner/ouvrir • Appui long (0,5 s) = note rapide • Tag = tape le numéro de siège demandé.
        </div>
      </div>
    </div>

    <!-- JOUEURS -->
    <div id="players" class="section">
      <div class="row">
        <input id="searchInput" placeholder="Rechercher par nom, tag..." />
        <button class="btn" id="btnAddPlayer">Ajouter</button>
      </div>
      <div class="spacer"></div>
      <div class="list" id="playersList"></div>
    </div>

    <!-- EXPORT / IMPORT -->
    <div id="export" class="section">
      <div class="card">
        <h3>Export</h3>
        <p class="muted">Rien n’est envoyé en ligne. Les fichiers sont générés sur l’iPhone.</p>
        <div class="row">
          <button class="btn btn-primary" id="btnExportJSON" type="button">Exporter JSON (ré-importable)</button>
        </div>
        <div id="copyFallback" class="muted" style="display:none;margin-top:8px">
          <div>Copie non disponible. Sélectionne manuellement :</div>
          <textarea id="jsonArea" readonly></textarea>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="card">
        <h3>Import</h3>
        <input type="file" id="importFile" accept="application/json" />
        <div class="row">
          <button class="btn" id="btnImport" type="button">Importer JSON</button>
          <button class="btn btn-danger" id="btnWipe" type="button">Effacer toutes les données</button>
        </div>
      </div>
    </div>

    <!-- AIDE / SÉCURITÉ -->
    <div id="help" class="section">
      <div class="card">
        <h3>Conseils & Sécurité</h3>
        <ul>
          <li>Tes données restent sur l’iPhone (stockage du site). Sauvegarde JSON régulièrement.</li>
          <li>Supprimer les “données de site” efface aussi l’app (notes + photos). Pense à exporter.</li>
          <li>Les photos sont des copies compressées : effacer la photo de ta pellicule ne l’efface pas ici.</li>
        </ul>
        <div class="spacer"></div>
        <div class="row">
          <button class="btn" id="btnSetPin">Définir/Changer PIN</button>
          <button class="btn btn-danger" id="btnRemovePin">Retirer PIN</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modal" id="playerModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:flex-end;justify-content:center;padding:0;z-index:20">
    <div class="sheet" style="width:100%;max-width:700px;background:var(--bg);border-radius:14px 14px 0 0;border:1px solid var(--outline);padding:12px 12px 14px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 id="pmTitle">Joueur</h3>
        <button class="btn btn-danger" id="pmDelete" type="button">Supprimer</button>
      </div>
      <div class="spacer"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><input id="pmName" placeholder="Nom / Pseudo" /></div>
        <div><input id="pmAlias" placeholder="Alias court (facultatif)" /></div>
      </div>
      <div class="spacer"></div>
      <div class="row" style="align-items:center;gap:12px">
        <img id="pmAvatar" class="avatar" alt="photo"/>
        <input type="file" id="pmPhoto" accept="image/*" />
      </div>
      <div class="spacer"></div>
      <div class="card"><div class="toolbar" id="pmTagList" style="display:flex;gap:8px;overflow:auto"></div></div>
      <div class="spacer"></div>
      <textarea id="pmNotes" placeholder="Reads, sizings, leaks, tells..."></textarea>
      <div class="spacer"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <input id="pmLastSeenWhere" placeholder="Lieu (ex: WSOP-C, Estoril...)" />
        <input id="pmLastSeenWhen" type="date" />
      </div>
      <div class="spacer"></div>
      <div class="row"><button class="btn btn-primary" id="pmSave" type="button">Enregistrer</button><button class="btn" id="pmClose" type="button">Fermer</button></div>
    </div>
  </div>

  <div class="modal" id="seatNoteModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:flex-end;justify-content:center;padding:0;z-index:20">
    <div class="sheet" style="width:100%;max-width:700px;background:var(--bg);border-radius:14px 14px 0 0;border:1px solid var(--outline);padding:12px 12px 14px">
      <h3 id="snmTitle">Note rapide – Siège</h3>
      <textarea id="snmText" placeholder="Ex: Limp UTG, call 3bet OOP, donk 1/2, show KTo..."></textarea>
      <div class="spacer"></div>
      <div class="row"><button class="btn btn-primary" id="snmSave" type="button">Ajouter</button><button class="btn" id="snmClose" type="button">Fermer</button></div>
    </div>
  </div>

<script>
(function(){
  const LS_KEY='pokerNotesDataV1';
  const PIN_KEY='pokerNotesPINv1';
  const customTags=["Slowplayer","Hit or Fold","Believer","Non believer","Nit","Value thin","Sizing face up","Stabeur","CS","Donk any pair","Recrea fold SB","Fastplay FD deep","Fastplayer","Trop passif","Baleine","LAG","Snapcall bluffcatch"];

  let state={players:{},seats:{count:9,tableName:"",map:{}}};

  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const uid=()=>Math.random().toString(36).slice(2,10);
  const save=()=>{ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){ alert("Stockage plein. Exporte puis nettoie."); } };
  const load=()=>{ const raw=localStorage.getItem(LS_KEY); if(raw){ try{ const o=JSON.parse(raw); if(o.players && o.seats) state=o; }catch(e){} } };

  /* ---------- PIN ---------- */
  function getPin(){ return localStorage.getItem(PIN_KEY)||""; }
  function setPin(pin){ if(pin) localStorage.setItem(PIN_KEY,pin); else localStorage.removeItem(PIN_KEY); }
  function requirePinIfSet(){
    const pin=getPin(); if(!pin) return;
    $('#pinLock').style.display='flex';
    $('#pinMsg').textContent="Entre ton code PIN";
    $('#pinInput').value="";
    setTimeout(()=>$('#pinInput').focus(),50);
    const ok=()=>{
      if($('#pinInput').value===pin){ $('#pinLock').style.display='none'; }
      else { $('#pinMsg').textContent="PIN incorrect. Réessaie."; $('#pinInput').value=""; $('#pinInput').focus(); }
    };
    $('#pinOk').onclick=ok;
    $('#pinCancel').onclick=()=>{ location.href='about:blank'; };
    $('#pinInput').onkeydown=(e)=>{ if(e.key==='Enter') ok(); };
  }

  /* ---------- Onglets ---------- */
  $$('.tab').forEach(t=>t.addEventListener('click',()=>{
    $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const id=t.dataset.tab; $$('.section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active');
    if(id==='players') renderPlayers();
    if(id==='table') { drawSeats(true); renderQuickTags(); }
  }));

  /* ---------- Barre de tags rapide (tags perso) ---------- */
  function renderQuickTags(){
    const bar=document.getElementById('quickTagsBar'); bar.innerHTML='';
    customTags.forEach(tag=>{
      const b=document.createElement('div'); b.className='chip'; b.textContent=tag;
      b.addEventListener('click', ()=>{
        const sel=prompt("Ajouter/retirer ce tag à quel siège ? (numéro)");
        const seatIdx=parseInt(sel,10);
        if(!Number.isFinite(seatIdx)) return;
        const seat=state.seats.map[seatIdx];
        if(!seat||!seat.playerId){ alert("Aucun joueur assigné à ce siège."); return; }
        const p=state.players[seat.playerId]; p.tags=p.tags||[];
        const i=p.tags.indexOf(tag); if(i>=0) p.tags.splice(i,1); else p.tags.push(tag);
        save(); renderPlayers(); drawSeats();
      }, {passive:true});
      bar.appendChild(b);
    });
  }

  /* ---------- Table & sièges ---------- */
  function initSeats(n){ state.seats.count=n; state.seats.map={}; for(let i=1;i<=n;i++) state.seats.map[i]={playerId:null,notes:[],stack:""}; }
  function ensureSeatDefaults(){ Object.keys(state.seats.map||{}).forEach(k=>{ const s=state.seats.map[k]; if(s && typeof s.stack==="undefined") s.stack=""; }); }

  function drawSeats(retry){
    const n=state.seats.count || 9;
    if(!state.seats.map || Object.keys(state.seats.map).length===0) initSeats(n);
    ensureSeatDefaults();

    $('#seatCount').value=String(n);
    $('#tableName').value=state.seats.tableName||'';

    const cont=$('#seatsContainer'); cont.innerHTML='';
    let w=cont.getBoundingClientRect().width; if(w===0 && retry){ requestAnimationFrame(()=>drawSeats(false)); return; } if(w===0) w=320;
    const center=w/2;

    for(let i=1;i<=n;i++){
      const seat=state.seats.map[i]||{playerId:null,notes:[],stack:""};
      const el=document.createElement('div'); el.className='seat'+(seat.playerId?' assigned':'');
      const angle=(i-1)*(360/n)-90, rad=angle*Math.PI/180, r=(w/2)-30;
      const x=center+r*Math.cos(rad)-50, y=center+r*Math.sin(rad)-59; el.style.left=x+'px'; el.style.top=y+'px';

      const pos=document.createElement('div'); pos.className='pos'; pos.textContent=i; el.appendChild(pos);

      const p=seat.playerId?state.players[seat.playerId]:null;
      if(p && p.photo){
        const av=document.createElement('img'); av.src=p.photo; av.alt=''; av.className='seat-avatar'; el.appendChild(av);
      }else{
        const ph=document.createElement('div'); ph.className='placeholder'; ph.innerHTML=`<svg width="42" height="42" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="8" r="4" stroke-width="1.5"></circle>
          <path d="M4 20c0-4 4-6 8-6s8 2 8 6" stroke-width="1.5"></path>
        </svg>`;
        el.appendChild(ph);
      }

      const stackInput=document.createElement('input');
      stackInput.className='stack'; stackInput.placeholder='ex: 35bb'; stackInput.inputMode='text';
      stackInput.autocapitalize='off'; stackInput.autocomplete='off'; stackInput.spellcheck=false;
      stackInput.value=seat.stack||'';
      ['touchstart','touchmove','touchend','mousedown','mouseup','click'].forEach(evt=>stackInput.addEventListener(evt, ev=>ev.stopPropagation(), {passive:true}));
      stackInput.addEventListener('input', ()=>{ state.seats.map[i].stack=stackInput.value.trim(); save(); });
      el.appendChild(stackInput);

      // Gestes (tap bref / long press)
      let t0=0,x0=0,y0=0,longTimer=null,didLong=false,moved=false; const MOVE_TOL=14;
      function startLong(){ didLong=false; moved=false; longTimer=setTimeout(()=>{ didLong=true; longTimer=null; openSeatNoteModal(i); }, 500); }
      function clearTimers(){ if(longTimer){ clearTimeout(longTimer); longTimer=null; } }
      el.addEventListener('touchstart', (e)=>{ const t=e.changedTouches[0]; t0=Date.now(); x0=t.clientX; y0=t.clientY; startLong(); }, {passive:true});
      el.addEventListener('touchmove', (e)=>{ const t=e.changedTouches[0]; const dx=t.clientX-x0,dy=t.clientY-y0; if(Math.hypot(dx,dy)>MOVE_TOL){ moved=true; clearTimers(); } }, {passive:true});
      el.addEventListener('touchcancel', ()=>{ clearTimers(); }, {passive:true});
      el.addEventListener('touchend', ()=>{ const dt=Date.now()-t0; clearTimers(); if(!didLong && !moved && dt<350){ openOrAssign(i); } }, {passive:true});
      let md=false,t0m=0;
      el.addEventListener('mousedown', (e)=>{ if(e.target===stackInput) return; md=true; t0m=Date.now(); startLong(); });
      el.addEventListener('mouseleave', ()=>{ md=false; clearTimers(); });
      el.addEventListener('mouseup', (e)=>{ if(e.target===stackInput) return; const dt=Date.now()-t0m; clearTimers(); if(md && !didLong && dt<350){ openOrAssign(i); } md=false; });

      cont.appendChild(el);
    }
  }
  window.addEventListener('resize', ()=>drawSeats(true));
  window.addEventListener('orientationchange', ()=>setTimeout(()=>drawSeats(true), 200));

  function openOrAssign(seatIdx){
    const s=state.seats.map[seatIdx];
    if(s.playerId){ openPlayerModal(s.playerId, seatIdx); }
    else { assignSeat(seatIdx); }
  }
  function assignSeat(seatIdx){
    const name=prompt("Nom/Pseudo du joueur à assigner ? (ou vide pour choisir existant)");
    if(name && name.trim()){
      const id=createPlayer({name:name.trim(),alias:""});
      state.seats.map[seatIdx].playerId=id; save(); drawSeats(); renderPlayers(); return;
    }
    const players=Object.values(state.players);
    if(players.length===0){ alert("Aucun joueur enregistré."); return; }
    const choice=prompt("Nom/alias exact:\n"+players.map(p=>p.alias||p.name||p.id).join(", "));
    if(!choice) return;
    const found=players.find(p=>(p.name||"").toLowerCase()===choice.toLowerCase()||(p.alias||"").toLowerCase()===choice.toLowerCase());
    if(!found){ alert("Introuvable."); return; }
    state.seats.map[seatIdx].playerId=found.id; save(); drawSeats();
  }

  /* ---------- Notes rapides ---------- */
  function openSeatNoteModal(seatIdx){
    document.getElementById('snmTitle').textContent="Note rapide – Siège "+seatIdx;
    const ta=document.getElementById('snmText'); ta.value=""; ta.focus();
    const saveNote=()=>{
      const t=ta.value.trim(); if(!t){ alert("Note vide."); return; }
      state.seats.map[seatIdx].notes.push(t);
      const pid=state.seats.map[seatIdx].playerId;
      if(pid){ const p=state.players[pid]; p.notes=(p.notes||"")+(p.notes? "\n":"")+"("+new Date().toLocaleString()+") "+t; }
      save(); drawSeats(); renderPlayers();
      document.getElementById('seatNoteModal').style.display='none';
    };
    document.getElementById('snmSave').onclick=saveNote;
    ta.onkeydown=(e)=>{ if(e.key==='Enter' && (e.metaKey||e.ctrlKey)){ e.preventDefault(); saveNote(); } };
    document.getElementById('snmClose').onclick=()=> document.getElementById('seatNoteModal').style.display='none';
    document.getElementById('seatNoteModal').style.display='flex';
  }

  /* ---------- Joueurs ---------- */
  function createPlayer({name,alias}){ const id=uid(); state.players[id]={id,name,alias,tags:[],notes:"",lastSeenWhere:"",lastSeenWhen:"",photo:null}; save(); return id; }
  function renderPlayers(){
    const q=(document.getElementById('searchInput').value||'').toLowerCase();
    const list=document.getElementById('playersList'); list.innerHTML='';
    const players=Object.values(state.players).sort((a,b)=>(a.alias||a.name||"").localeCompare(b.alias||b.name||""));
    players.forEach(p=>{
      const text=[p.name,p.alias,(p.tags||[]).join(" "),p.notes].join(" ").toLowerCase(); if(q && !text.includes(q)) return;
      const row=document.createElement('div'); row.className='card'; row.innerHTML=`
        <div class="player-row">
          <img class="avatar sm" src="${p.photo||''}" alt=""/>
          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;gap:6px;align-items:center">
              <strong>${escapeHtml(p.alias||p.name||'—')}</strong>
              <div class="pill">${(p.tags||[]).slice(0,3).join(' · ')}</div>
            </div>
            <div class="muted" style="font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml((p.notes||'').split('\n').slice(-1)[0]||'')}</div>
          </div>
          <button class="btn" data-id="${p.id}" type="button">Ouvrir</button>
        </div>`;
      row.querySelector('button').onclick=()=>openPlayerModal(p.id);
      list.appendChild(row);
    });
  }
  function openPlayerModal(id){
    const p=state.players[id]; if(!p) return;
    document.getElementById('pmTitle').textContent="Joueur • "+(p.alias||p.name||"");
    document.getElementById('pmName').value=p.name||"";
    document.getElementById('pmAlias').value=p.alias||"";
    document.getElementById('pmAvatar').src=p.photo||"";
    document.getElementById('pmNotes').value=p.notes||"";
    document.getElementById('pmLastSeenWhere').value=p.lastSeenWhere||"";
    document.getElementById('pmLastSeenWhen').value=p.lastSeenWhen||"";
    renderPlayerTagChips(p);
    document.getElementById('playerModal').style.display='flex';

    document.getElementById('pmDelete').onclick=()=>{
      if(!confirm("Supprimer ce joueur ?")) return;
      Object.values(state.seats.map).forEach(s=>{ if(s.playerId===p.id) s.playerId=null; });
      delete state.players[p.id]; save(); document.getElementById('playerModal').style.display='none'; renderPlayers(); drawSeats();
    };
    document.getElementById('pmSave').onclick=()=>{
      p.name=document.getElementById('pmName').value.trim();
      p.alias=document.getElementById('pmAlias').value.trim();
      p.notes=document.getElementById('pmNotes').value;
      p.lastSeenWhere=document.getElementById('pmLastSeenWhere').value.trim();
      p.lastSeenWhen=document.getElementById('pmLastSeenWhen').value;
      save(); document.getElementById('playerModal').style.display='none'; renderPlayers(); drawSeats();
    };
    document.getElementById('pmClose').onclick=()=> document.getElementById('playerModal').style.display='none';

    document.getElementById('pmPhoto').onchange=async (e)=>{
      const file=e.target.files[0]; if(!file) return;
      const dataUrl=await fileToResizedDataURL(file,256,256);
      p.photo=dataUrl; document.getElementById('pmAvatar').src=dataUrl; save(); renderPlayers(); drawSeats();
    };
  }
  function renderPlayerTagChips(p){
    const cont=document.getElementById('pmTagList'); cont.innerHTML='';
    customTags.forEach(tag=>{
      const el=document.createElement('div'); el.className='pill'; el.textContent=tag; el.style.cursor='pointer';
      if(p.tags&&p.tags.includes(tag)) el.style.outline='2px solid var(--accent)';
      el.addEventListener('click', ()=>{ p.tags=p.tags||[]; const i=p.tags.indexOf(tag); if(i>=0) p.tags.splice(i,1); else p.tags.push(tag); save(); renderPlayerTagChips(p); renderPlayers(); drawSeats(); }, {passive:true});
      cont.appendChild(el);
    });
  }

  /* ---------- Helpers ---------- */
  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) ); }
  function fileToResizedDataURL(file, maxW, maxH){
    return new Promise((resolve,reject)=>{
      const img=new Image(); const rdr=new FileReader();
      rdr.onload=e=>{ img.onload=()=>{
        let w=img.width,h=img.height; const r=Math.min(maxW/w, maxH/h, 1);
        const cw=Math.round(w*r), ch=Math.round(h*r); const c=document.createElement('canvas'); c.width=cw; c.height=ch;
        const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,cw,ch); resolve(c.toDataURL('image/jpeg',0.8));
      }; img.onerror=reject; img.src=e.target.result; };
      rdr.onerror=reject; rdr.readAsDataURL(file);
    });
  }
  function download(name, content, type='application/json'){
    const blob=new Blob([content],{type});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=name;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  /* ---------- Export JSON-only / Import / Wipe ---------- */
  document.getElementById('btnExportJSON').onclick=()=>{
    download('poker-notes.json', JSON.stringify(state,null,2), 'application/json');
  };
  document.getElementById('btnImport').onclick=()=>{
    const f=document.getElementById('importFile').files[0]; if(!f){ alert('Choisis un fichier .json'); return; }
    const rdr=new FileReader(); rdr.onload=e=>{
      try{ const obj=JSON.parse(e.target.result); if(!obj.players||!obj.seats) throw new Error('Format inconnu.');
        state=obj; ensureSeatDefaults(); save(); drawSeats(); renderPlayers(); alert('Import OK.');
      } catch(err){ alert('Erreur import.'); }
    }; rdr.readAsText(f);
  };
  document.getElementById('btnWipe').onclick=()=>{
    if(!confirm('Effacer TOUTES les données ?')) return;
    localStorage.removeItem(LS_KEY); state={players:{},seats:{count:9,tableName:'',map:{}}}; initSeats(9); save(); drawSeats(); renderPlayers();
  };

  /* ---------- PIN settings ---------- */
  document.getElementById('btnSetPin').onclick=()=>{
    const cur=getPin(); const p1=prompt("Nouveau PIN (4–6 chiffres):", cur||""); if(!p1) return;
    if(!/^\d{4,6}$/.test(p1)){ alert("PIN invalide (4–6 chiffres)."); return; }
    const p2=prompt("Confirme le PIN:",""); if(p2!==p1){ alert("Mismatch."); return; }
    setPin(p1); alert("PIN enregistré.");
  };
  document.getElementById('btnRemovePin').onclick=()=>{
    if(!getPin()) { alert("Pas de PIN défini."); return; }
    if(confirm("Retirer le PIN ?")){ setPin(""); alert("PIN retiré."); }
  };

  /* ---------- Wiring global ---------- */
  document.getElementById('seatCount').onchange=e=>{ const n=parseInt(e.target.value,10); initSeats(n); save(); drawSeats(true); };
  document.getElementById('tableName').oninput=e=>{ state.seats.tableName=e.target.value; save(); };
  document.getElementById('btnClearTable').onclick=()=>{
    if(!confirm('Retirer tous les joueurs de la table ?')) return;
    Object.keys(state.seats.map).forEach(k=>{ state.seats.map[k].playerId=null; state.seats.map[k].notes=[]; state.seats.map[k].stack=""; }); save(); drawSeats(true);
  };
  document.getElementById('btnAddPlayer').onclick=()=>{ const name=prompt('Nom/Pseudo ?'); if(!name) return; const id=createPlayer({name:name.trim(),alias:''}); openPlayerModal(id); };
  document.getElementById('searchInput').oninput=renderPlayers;

  /* ---------- Init ---------- */
  load(); if(!state.seats||!state.seats.map||!state.seats.count) initSeats(9);
  requirePinIfSet();
  requestAnimationFrame(()=>{ drawSeats(true); renderQuickTags(); }); renderPlayers();
})();
</script>
</body>
</html>
